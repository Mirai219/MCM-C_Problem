# 任务一模型说明（Season 11 / MAP 点估计版）

> 本文档仅总结**任务一**所用模型：从给定的“裁判打分 + 实际淘汰结果”中，**反推每周每位选手的粉丝支持度（票占比）**的一个可计算方案。  
> 当前实现为：**Dirichlet 先验 + softmax 软淘汰似然 + MAP（最大后验）点估计**，并按照简化假设“每周恰好淘汰 1 人”筛选可用周。

---

## 1. 任务一目标与输入输出

### 1.1 目标（要估计的量）
对某赛季中每一周 $t$，对当周仍在赛的选手集合 $A_t$，估计当周每位选手的粉丝支持度（票占比）：
$$
\mathbf v_t = (v_{i,t})_{i\in A_t},\quad v_{i,t}\ge 0,\ \sum_{i\in A_t} v_{i,t}=1
$$
其中 $v_{i,t}$ 表示“当周粉丝投票（或支持）在 alive 选手中的占比”。

> 注意：我们估计的是**占比**而非绝对票数，因为绝对总票数未知且可能随周变化。

### 1.2 输入（来自题目数据）
- 每周各裁判对每位选手的打分（可能存在 `N/A`）
- 每位选手在被淘汰后，后续周的分数在数据中被记为 **0**（结构性规则）
- 通过“本周/下周是否变为 0”等规则推断每周被淘汰者（见数据处理部分）

### 1.3 输出（本次实现）
输出为 long-format 表格 `season11_map_vhat.csv`，主要字段：
- `season`：赛季（本次只跑 season=11）
- `week`：周次
- `celebrity_name`：选手名（作为 ID）
- `v_hat`：该周该选手的 MAP 点估计支持度 $\hat v_{i,t}$
- `is_eliminated_that_week`：该周是否被淘汰（1/0）

同一周内，所有 alive 选手的 `v_hat` 之和为 1。

---

## 2. 核心建模思想：逆问题 → 概率模型（贝叶斯）→ MAP

### 2.1 为什么需要概率模型
每周观测到的信息只有“谁被淘汰了”（一个类别标签），但要反推的是一整组连续变量 $\mathbf v_t$（维度为 $|A_t|-1$ 个自由度）。  
这属于典型的**逆问题（多解）**：能导致同样淘汰结果的 $\mathbf v_t$ 组合有很多组。

因此我们采用：
- **先验（prior）**：在多解中偏向“合理”的票占比结构（非负、和为 1，并可调节对极端值的偏好）
- **似然（likelihood）**：用“支持度 + 裁判分”共同决定淘汰概率（软淘汰）
- **后验（posterior）**：综合先验与观测，得到 $\mathbf v_t$ 的后验分布
- **MAP（最大后验）**：取后验分布的最大点作为点估计 $\hat{\mathbf v}_t$

MAP 的数学形式：
$$
\hat{\mathbf v}_t
= \arg\max_{\mathbf v_t\in\Delta} \Big[ \log p(e_t\mid \mathbf v_t,\text{judge}) + \log p(\mathbf v_t)\Big]
$$
其中 $\Delta$ 是单纯形（概率向量）约束集。

---

## 3. 模型假设、适用范围与边界

### 3.1 数据层假设（本次实现采用的简化）
1. **每周恰好淘汰 1 人**  
   - 数据中可能存在“无人淘汰”或“多人淘汰”的周，本版本**直接过滤**这类周，不参与拟合。
2. **淘汰识别规则有效**  
   - 当周仍在赛：当周裁判总分 $J_{i,t} > 0$ 且非缺失  
   - 淘汰者：满足 $J_{i,t} > 0$ 且 **下周 $J_{i,t+1}=0$**（并且下周不是“整周不存在”的缺失）
3. **`N/A` 的区分处理**  
   - 若该周裁判列为 `N/A`：视为缺失，不参与求和  
   - 若该周整周不存在（赛季没那么多周）：该周对所有选手均为缺失（全 `N/A`），该周不建模

### 3.2 机制层假设（比赛淘汰机制的抽象）
1. **综合分决定淘汰倾向**  
   当周每位选手有一个潜在“综合分” $S_{i,t}$，越小越容易被淘汰。
2. **综合分由裁判与粉丝支持线性融合**  
   $$
   S_{i,t} = w\tilde J_{i,t} + (1-w)v_{i,t}
   $$
   其中 $w\in[0,1]$ 为裁判权重（本实现固定为常数，如 0.5）。
3. **淘汰是“软规则”而非硬规则**  
   淘汰者不是严格意义上的 $\arg\min S$，而是概率更大地来自低 $S$ 选手，用 softmax 表示：
   $$
   \Pr(e_t=i) = \frac{\exp(-\beta S_{i,t})}{\sum_{k\in A_t}\exp(-\beta S_{k,t})}
   $$
   $\beta>0$ 控制“规则硬度”：  
   - $\beta$ 大：更接近“最低者必淘汰”  
   - $\beta$ 小：淘汰更随机

### 3.3 适用范围
- 适用于：已知**逐周裁判打分**且能从数据推断出**逐周淘汰者**的赛季
- 适用于：想得到“当周各选手相对支持度占比”的场景
- 当前实现特别适用于：先完成任务一的**可计算 baseline**（MAP 点估计）

### 3.4 明确不覆盖的情况（本版本限制）
- 不处理：某周无人淘汰
- 不处理：某周淘汰多于 1 人
- 不输出：不确定性区间（目前只做 MAP 点估计）
- 不做：跨周/跨赛季的人气平滑演化（每周独立估计）

---

## 4. 数学定义与推导（任务一核心公式）

### 4.1 裁判分标准化
直接用裁判总分 $J_{i,t}$ 会受周尺度影响，因此先转成当周占比：
$$
\tilde J_{i,t} = \frac{J_{i,t}}{\sum_{k\in A_t} J_{k,t}}
$$
这样 $\tilde J_{i,t}$ 与 $v_{i,t}$ 都是“占比”量纲，便于融合。

### 4.2 先验：Dirichlet
对当周票占比向量 $\mathbf v_t$ 设 Dirichlet 先验：
$$
\mathbf v_t \sim \text{Dirichlet}(\boldsymbol\alpha)
$$
其对数先验（忽略与 $\mathbf v$ 无关的常数项）：
$$
\log p(\mathbf v_t) = \sum_{i\in A_t} (\alpha_i-1)\log v_{i,t}
$$
本版本常用：$\alpha_i=\alpha$（同一个常数）。

- $\alpha=1$：无偏、较宽松（允许极端接近 0/1）  
- $\alpha>1$：更偏向均匀（惩罚极端）  
- $\alpha<1$：更偏向尖峰（更极端）

### 4.3 似然：softmax 软淘汰
综合分：
$$
S_{i,t} = w\tilde J_{i,t} + (1-w)v_{i,t}
$$
淘汰者分布（当周观测到淘汰者 $e_t$）：
$$
\Pr(e_t=i\mid \mathbf v_t) =
\frac{\exp(-\beta S_{i,t})}{\sum_{k\in A_t}\exp(-\beta S_{k,t})}
$$
对数似然：
$$
\log p(e_t\mid \mathbf v_t) =
-\beta S_{e_t,t} - \log\sum_{k\in A_t}\exp(-\beta S_{k,t})
$$

### 4.4 MAP 目标
最大化后验等价于最大化（对数似然 + 对数先验）：
$$
\hat{\mathbf v}_t
=
\arg\max_{\mathbf v_t\in\Delta}
\Big[
\log p(e_t\mid \mathbf v_t) + \log p(\mathbf v_t)
\Big]
$$

---

## 5. 计算实现：为什么用无约束变量 $z$ + softmax

直接在单纯形 $\Delta$ 上优化有约束。实现中引入无约束参数：
$$
\mathbf z_t \in \mathbb R^{|A_t|}
$$
用 softmax 映射回票占比：
$$
v_{i,t} = \frac{e^{z_{i,t}}}{\sum_{k\in A_t}e^{z_{k,t}}}
$$
这样自动满足：
- $v_{i,t}\ge 0$
- $\sum_i v_{i,t}=1$

于是优化变量变成 $\mathbf z_t$ 的无约束优化（更稳定、实现更简单）。

---

## 6. 工作流程（从原始表到最终 v_hat）

### 6.1 数据清洗与周结构构造
对指定赛季（本次：Season 11）：

1. **识别列名模式**  
   找到所有 `weekX_judgeY_score` 列，按 week 聚合。
2. **计算每位选手每周裁判总分**  
   对每周将该周所有 judge 分数列转为数值：`N/A -> NaN`，行求和（跳过 NaN）：
   $$
   J_{i,t} = \sum_{j\in\text{judges}} \text{score}_{i,t,j}
   $$
   若该周所有裁判列全为 NaN（整周不存在），将 $J_{i,t}$ 设为 NaN。
3. **确定当周 alive 集合**  
   $$
   A_t=\{i: J_{i,t} > 0\ \text{且}\ J_{i,t}\ \text{非缺失}\}
   $$
4. **确定淘汰者（简化假设：每周一个）**  
   设下周总分 $J_{i,t+1}$，淘汰候选为：
   $$
   E_t=\{i\in A_t: J_{i,t+1}=0\ \text{且}\ J_{i,t+1}\ \text{非缺失}\}
   $$
   仅当 $|E_t|=1$ 时，认为该周可用，并记录唯一淘汰者 $e_t$。

> 说明：本版本直接丢弃 $|E_t|\neq 1$ 的周，满足“每周恰好淘汰 1 人”的简化。

5. **计算裁判占比**  
   对 alive 选手：
   $$
   \tilde J_{i,t} = \frac{J_{i,t}}{\sum_{k\in A_t}J_{k,t}}
   $$
6. **组装 WeekData**  
   对每个可用周，存储：`alive_ids, judge_share, eliminated_idx`。

### 6.2 单周 MAP 求解（核心）
对每个 WeekData（一周）：

1. 初始化 $\mathbf z$（全 0）
2. 计算 $\mathbf v=\text{softmax}(\mathbf z)$
3. 计算综合分 $S$、淘汰概率及 log-likelihood
4. 计算 Dirichlet log-prior
5. 构造 loss：
   $$
   \text{loss}(\mathbf z)=-(\log p(e_t\mid \mathbf v)+\log p(\mathbf v))
   $$
6. 使用优化器最小化 loss，得到 $\mathbf z^*$
7. 输出 $\hat{\mathbf v}=\text{softmax}(\mathbf z^*)$

实现上使用 PyTorch 自动求导 + L-BFGS（拟牛顿）优化。

### 6.3 汇总输出
遍历所有可用周，将每周的 $\hat v_{i,t}$ 写入 long-format CSV：
- 便于后续任务（比如任务二）以及可视化（热力图、趋势图）

---

## 7. 超参数解释与推荐调参方式

模型使用 3 个关键超参数（本版本固定后直接运行）：

1. **$w$**：裁判权重  
   - 大：裁判分主导淘汰  
   - 小：粉丝支持主导淘汰  
   推荐：先用 $w=0.5$ baseline；后续可做敏感性分析（如 0.3/0.7）。

2. **$\beta$**：淘汰规则硬度  
   - 大：近似硬淘汰（更容易推到极端解）
   - 小：淘汰更“软”，更不极端  
   推荐：先用 $\beta=10$ baseline；若发现淘汰者支持度普遍接近 0，可调小（如 3–5）。

3. **$\alpha$**：Dirichlet 先验强度  
   - $\alpha=1$：宽松无偏，允许极端（本实现采用）
   - $\alpha>1$：更偏均匀，抑制 $v\to0$  
   推荐：若需要更“平滑/现实”的点估计，可取 $\alpha=2$ 或 5。

> 本次我们接受“淘汰者 v_hat 可能非常接近 0”的结果，因此保持 $\alpha=1,\beta=10$ 不变。

---

## 8. 结果解读（如何理解 v_hat）

- 同一周内 `v_hat` 总和为 1：表示相对支持份额
- `v_hat` 大：模型认为“在该周要解释淘汰结果，这位选手需要承担更高的粉丝支持占比”
- `v_hat` 接近 0（尤其淘汰者）：在当前超参数组合下，MAP 常将淘汰者推向低支持度以最大化“被淘汰”似然，这是 MAP + 宽松先验 + 较硬淘汰模型的典型行为

---

## 9. 复杂度与可复现性

- 设可用周数为 $T$，第 $t$ 周 alive 人数为 $n_t$
- 每周一次无约束优化，主要开销来自 L-BFGS 迭代
- 总体复杂度约为：
  $$
  O\Big(\sum_{t=1}^{T} \text{Iter}\cdot n_t\Big)
  $$
- 代码中默认 `seed` 固定，保证可重复的优化路径（在确定性优化中影响不大，但保留良好习惯）

---

## 10. 可扩展方向（不影响任务一结论，但为后续任务准备）

虽然任务一只要求反推支持度，本模型可自然扩展为更完整版本：

1. **支持“无人淘汰/多人淘汰”周**  
   - 无淘汰：将该周作为无观测周（只用先验/平滑）
   - 多淘汰：使用 Plackett–Luce 或 bottom-k 似然

2. **跨周动态支持度（平滑演化）**  
   Logistic-Normal / state-space：
   $$
   \mathbf z_t\sim \mathcal N(\mathbf z_{t-1},\Sigma),\quad \mathbf v_t=\text{softmax}(\mathbf z_t)
   $$
   可反映“粉丝支持随周缓慢变化”的现实。

3. **不确定性量化（区间）**  
   在 MAP 基础上使用 Laplace 近似或采样，得到 credible interval。

---

## 11. 小结（任务一完成了什么）
本任务一模型完成了以下工作：

1. 从原始评分表中对 Season 11 进行数据清洗，构建每周 alive 集合与淘汰者标注（在“每周淘汰 1 人”的假设下筛选周）
2. 将每周裁判总分标准化为占比 $\tilde J$，与粉丝占比 $v$ 统一尺度
3. 通过“裁判占比 + 粉丝占比 → 综合分 → softmax 软淘汰概率”建立淘汰生成机制
4. 采用 Dirichlet 先验约束票占比形状，形成后验目标
5. 对每周独立求解 MAP 点估计，输出 $\hat v_{i,t}$ 作为“当周粉丝支持度”估计
6. 输出 long-format 结果表，便于后续绘图与任务二/三建模衔接

---

## 附：本次文件与图形产物
- 结果表：`season11_map_vhat.csv`
- 可视化（后续已绘制）：  
  - `season11_heatmap_vhat.png`（全景热力图）  
  - `season11_top5_trend_vhat.png`（Top-5 趋势折线图）
